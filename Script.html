const SHEET_ID = '1kR_fzOJBvxyB0dX_ndh-cDsTdNcxTMPKoCk5htg9Axo'; 

function doPost(e) {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  const data = JSON.parse(e.postData.contents);
  const action = data.action;

  try {
    if (action === 'register_store') return registerStore(ss, data);
    if (action === 'login_store') return loginStore(ss, data);
    if (action === 'add_product') return addProduct(ss, data);
    if (action === 'edit_product') return editProduct(ss, data);
    if (action === 'delete_product') return deleteProduct(ss, data);
    if (action === 'register_customer') return registerCustomer(ss, data);
    if (action === 'login_customer') return loginCustomer(ss, data);
    if (action === 'place_order') return placeOrder(ss, data);
    if (action === 'update_order_status') return updateOrderStatus(ss, data);
    
    return response({status: 'error', message: 'Unknown Action'});
  } catch (err) {
    return response({status: 'error', message: 'Server Error: ' + err.toString()});
  }
}

function doGet(e) {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  const action = e.parameter.action;

  if (action === 'get_all_data') return getAllData(ss);
  if (action === 'get_store_products') return getStoreProducts(ss, e.parameter.store_id);
  if (action === 'get_store_orders') return getStoreOrders(ss, e.parameter.store_id);
  if (action === 'get_customer_orders') return getCustomerOrders(ss, e.parameter.phone);
  
  return response({status: 'error', message: 'Invalid GET action'});
}

// --- PARTNER REGISTRATION (DUPLICATE CHECK) ---
function registerStore(ss, data) {
  const sheet = ss.getSheetByName('Stores');
  const rows = sheet.getDataRange().getValues();
  
  // Check for duplicates (Name + Phone)
  for (let i = 1; i < rows.length; i++) {
    if (String(rows[i][1]).toLowerCase() === String(data.store_name).toLowerCase() && 
        String(rows[i][3]) === String(data.phone)) {
      return response({status: 'error', message: 'This Store is already registered.'});
    }
  }

  const lastRow = sheet.getLastRow();
  let newId = 'MED-' + (1000 + lastRow); 
  if (lastRow === 1) newId = 'MED-1001';

  sheet.appendRow([
    newId, 
    data.store_name, 
    data.owner_name, 
    data.phone, 
    data.city, 
    data.address, 
    new Date()
  ]);
  return response({status: 'success', store_id: newId});
}

// --- PARTNER LOGIN (SECURE: ID + PHONE) ---
function loginStore(ss, data) {
  const sheet = ss.getSheetByName('Stores');
  const rows = sheet.getDataRange().getValues();
  
  for(let i=1; i<rows.length; i++) {
    // Check ID (Col A) AND Phone (Col D)
    const idMatch = String(rows[i][0]).trim() == String(data.store_id).trim();
    const phoneMatch = String(rows[i][3]).trim() == String(data.phone).trim();

    if(idMatch && phoneMatch) {
       return response({
         status:'success', 
         store_data: {
           id: rows[i][0], 
           name: rows[i][1] // Store Name
         }
       });
    }
  }
  return response({status:'error', message: 'Invalid Store ID or Mobile Number'});
}

// --- PRODUCT MANAGEMENT ---
function addProduct(ss, data) {
  const sheet = ss.getSheetByName('Products');
  const id = 'PROD-' + Date.now();
  const row = [String(id), String(data.store_id), String(data.category), String(data.medicine_name), Number(data.price), String(data.image_url||''), String(data.description||''), 'TRUE', String(data.private_notes||''), new Date()];
  sheet.appendRow(row);
  return response({status: 'success', message: 'Product Added'});
}

function editProduct(ss, data) {
  const sheet = ss.getSheetByName('Products');
  const rows = sheet.getDataRange().getValues();
  for (let i = 1; i < rows.length; i++) {
    if (rows[i][0] == data.product_id && rows[i][1] == data.store_id) {
      if(data.only_stock) {
        sheet.getRange(i+1, 8).setValue(data.in_stock); 
      } else {
        sheet.getRange(i+1, 3, 1, 7).setValues([[data.category, data.medicine_name, data.price, data.image_url, data.description, data.in_stock, data.private_notes]]);
      }
      return response({status: 'success', message: 'Updated'});
    }
  }
  return response({status: 'error', message: 'Product not found'});
}

function deleteProduct(ss, data) {
  const sheet = ss.getSheetByName('Products');
  const rows = sheet.getDataRange().getValues();
  for (let i = 1; i < rows.length; i++) {
    if (rows[i][0] == data.product_id && rows[i][1] == data.store_id) {
      sheet.deleteRow(i + 1);
      return response({status: 'success', message: 'Deleted'});
    }
  }
  return response({status: 'error', message: 'Product not found'});
}

// --- ORDERS ---
function placeOrder(ss, data) {
  const sheet = ss.getSheetByName('Orders');
  const orderId = 'ORD-' + Math.floor(Math.random() * 1000000);
  sheet.appendRow([orderId, data.store_id, data.customer_name, data.customer_phone, data.customer_address, data.order_items, data.total_amount, new Date(), 'Pending']);
  
  const stores = ss.getSheetByName('Stores').getDataRange().getValues();
  let storePhone = "N/A", storeName = "Unknown";
  for(let i=1; i<stores.length; i++){
    if(stores[i][0] == data.store_id) { storeName=stores[i][1]; storePhone=stores[i][3]; break; }
  }
  return response({status: 'success', order_id: orderId, store_phone: storePhone, store_name: storeName});
}

function updateOrderStatus(ss, data) {
  const sheet = ss.getSheetByName('Orders');
  const rows = sheet.getDataRange().getValues();
  for (let i = 1; i < rows.length; i++) {
    if (rows[i][0] == data.order_id && rows[i][1] == data.store_id) {
      sheet.getRange(i + 1, 9).setValue(data.status);
      return response({status: 'success'});
    }
  }
  return response({status: 'error', message: 'Not found'});
}

// --- DATA FETCHING ---
function getAllData(ss) {
  const stores = ss.getSheetByName('Stores').getDataRange().getValues().slice(1);
  const products = ss.getSheetByName('Products').getDataRange().getValues().slice(1);
  const storeMap = {};
  stores.forEach(s => storeMap[s[0]] = {name: s[1], city: s[4]});
  
  const formatted = products.map(p => ({
    id: p[0], store_id: p[1], category: p[2], name: p[3], price: p[4], image: p[5], description: p[6], in_stock: p[7],
    store_name: storeMap[p[1]] ? storeMap[p[1]].name : 'Unknown Store',
    store_city: storeMap[p[1]] ? storeMap[p[1]].city : ''
  }));
  return response({status: 'success', products: formatted});
}

function getStoreProducts(ss, storeId) {
  const rows = ss.getSheetByName('Products').getDataRange().getValues().slice(1);
  const myProducts = rows.filter(r => r[1] == storeId).map(r => ({
    id: r[0], category: r[2], name: r[3], price: r[4], image: r[5], description: r[6], in_stock: r[7], private_notes: r[8]
  }));
  return response({status: 'success', products: myProducts});
}

function getStoreOrders(ss, storeId) {
  const rows = ss.getSheetByName('Orders').getDataRange().getValues().slice(1);
  const myOrders = rows.filter(r => r[1] == storeId).map(r => ({
    order_id: r[0], customer_name: r[2], customer_phone: r[3], customer_address: r[4], items: r[5], total: r[6], date: r[7], status: r[8]
  }));
  return response({status: 'success', orders: myOrders.reverse()});
}

function getCustomerOrders(ss, phone) {
  const storeSheet = ss.getSheetByName('Stores').getDataRange().getValues().slice(1);
  const storeMap = {};
  storeSheet.forEach(s => storeMap[s[0]] = {name: s[1], phone: s[3]});

  const rows = ss.getSheetByName('Orders').getDataRange().getValues().slice(1);
  const myOrders = rows.filter(r => r[3] == phone).map(r => ({
    order_id: r[0], store_name: storeMap[r[1]] ? storeMap[r[1]].name : 'Unknown Store', store_phone: storeMap[r[1]] ? storeMap[r[1]].phone : 'N/A',
    items: r[5], total: r[6], date: r[7], status: r[8]
  }));
  return response({status: 'success', orders: myOrders.reverse()});
}

// --- CLIENT AUTH ---
function registerCustomer(ss, data) {
  ss.getSheetByName('Customers').appendRow(['CUST-'+Date.now(), data.name, data.phone, data.password, data.address]);
  return response({status:'success', name: data.name, phone: data.phone, address: data.address});
}
function loginCustomer(ss, data) {
  const rows = ss.getSheetByName('Customers').getDataRange().getValues();
  for(let i=1; i<rows.length; i++) if(rows[i][2] == data.phone && rows[i][3] == data.password) return response({status:'success', customer_data:{name:rows[i][1], phone:rows[i][2], address:rows[i][4]}});
  return response({status:'error'});
}
function response(data) { return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON); }