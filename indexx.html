<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediPlus - AI Enabled</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Outfit', sans-serif; background-color: #f4f5f8; }
        
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid #fff; width: 18px; height: 18px; animation: spin 0.8s linear infinite; display: inline-block; vertical-align: middle; }
        .spinner-dark { border: 3px solid rgba(0, 128, 128, 0.3); border-top: 3px solid teal; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .hidden-section { display: none !important; }
        .modal-overlay { background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .chat-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="text-gray-800 antialiased">

    <div id="toastBox" class="fixed top-5 right-5 z-[100] flex flex-col gap-3 pointer-events-none"></div>

    <div class="fixed bottom-6 right-6 z-[90] flex flex-col items-end gap-4">
        <div id="aiChatWindow" class="hidden bg-white w-[90vw] md:w-96 h-[500px] rounded-2xl shadow-2xl border border-gray-100 flex flex-col overflow-hidden chat-slide-up origin-bottom-right">
            <div class="bg-gradient-to-r from-teal-600 to-teal-500 p-4 flex justify-between items-center text-white">
                <div class="flex items-center gap-3">
                    <div class="bg-white/20 w-10 h-10 rounded-full flex items-center justify-center backdrop-blur-sm">
                        <i class="fas fa-robot text-lg"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg leading-tight">MediPlus AI</h3>
                        <p class="text-[10px] text-teal-100 opacity-90">Instant Medicine Consultant</p>
                    </div>
                </div>
                <button onclick="toggleAiChat()" class="text-white/80 hover:text-white transition"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div id="aiMessages" class="flex-grow overflow-y-auto p-4 space-y-4 bg-gray-50">
                <div class="flex gap-3">
                    <div class="w-8 h-8 rounded-full bg-teal-100 flex-shrink-0 flex items-center justify-center text-teal-600 text-xs"><i class="fas fa-robot"></i></div>
                    <div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm text-sm text-gray-700 border border-gray-100">
                        Hello! I can help you find medicines on our website or consult on symptoms. <br><br><b>How can I help you today?</b>
                    </div>
                </div>
            </div>

            <div id="aiTyping" class="hidden px-4 pb-2 bg-gray-50">
                <div class="flex gap-1 ml-11 bg-gray-200 w-fit px-3 py-2 rounded-xl rounded-tl-none">
                    <div class="w-2 h-2 bg-gray-500 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-gray-500 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-gray-500 rounded-full typing-dot"></div>
                </div>
            </div>
            
            <div class="p-3 bg-white border-t border-gray-100 flex gap-2">
                <input type="text" id="aiInput" onkeydown="handleAiEnter(event)" placeholder="Ask about medicine..." class="flex-grow bg-gray-50 border border-gray-200 rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-teal-500 transition">
                <button onclick="sendAiMessage()" class="bg-teal-600 text-white w-10 h-10 rounded-xl flex items-center justify-center hover:bg-teal-700 transition shadow-md active:scale-95"><i class="fas fa-paper-plane text-xs"></i></button>
            </div>
        </div>

        <button onclick="toggleAiChat()" class="bg-gray-900 hover:bg-teal-600 text-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center transition-all duration-300 transform hover:scale-110 group">
            <i class="fas fa-comment-medical text-2xl group-hover:animate-pulse"></i>
            <span class="absolute -top-1 -right-1 bg-red-500 w-4 h-4 rounded-full border-2 border-white"></span>
        </button>
    </div>
    <div id="app-public" class="pb-24 transition-opacity duration-300">
        
        <nav class="bg-white shadow-sm sticky top-0 z-40">
            <div class="container mx-auto px-4 h-16 flex justify-between items-center">
                <div class="flex items-center gap-2 cursor-pointer select-none" onclick="showPublicHome()">
                    <div class="bg-teal-600 text-white w-9 h-9 rounded-xl flex items-center justify-center font-bold text-lg shadow-md"><i class="fas fa-plus"></i></div>
                    <span class="text-xl font-bold tracking-tight text-gray-800">Medi<span class="text-teal-600">Plus</span></span>
                </div>
                <div id="authContainer" class="flex items-center gap-3"></div>
            </div>
        </nav>

        <section id="view-home" class="container mx-auto px-4 mt-6 fade-in">
            <div class="bg-gradient-to-br from-teal-500 to-emerald-700 rounded-2xl p-6 md:p-10 text-white shadow-xl mb-8 relative overflow-hidden">
                <div class="relative z-10 text-center max-w-3xl mx-auto">
                    <h1 class="text-3xl md:text-5xl font-extrabold mb-4 leading-tight">Healthcare, Delivered.</h1>
                    <p class="text-teal-100 mb-6 text-sm md:text-base">Order medicines from trusted local pharmacies with instant delivery.</p>
                    <div class="bg-white rounded-xl shadow-2xl flex items-center p-2 transform transition hover:scale-[1.01]">
                        <i class="fas fa-search text-gray-400 ml-3 text-lg"></i>
                        <input type="text" id="publicSearch" onkeyup="searchPublic()" placeholder="Search 'Paracetamol' or 'Syrup'..." class="flex-grow p-3 outline-none text-gray-700 placeholder-gray-400 font-medium bg-transparent">
                    </div>
                </div>
                <div class="absolute top-0 left-0 w-40 h-40 bg-white opacity-10 rounded-full -translate-x-1/2 -translate-y-1/2 blur-2xl"></div>
                <div class="absolute bottom-0 right-0 w-64 h-64 bg-teal-400 opacity-20 rounded-full translate-x-1/3 translate-y-1/3 blur-3xl"></div>
            </div>

            <div class="mb-10">
                <div class="flex justify-between items-end mb-4 px-1">
                    <h3 class="font-bold text-xl text-gray-800">Categories</h3>
                </div>
                <div class="flex gap-4 overflow-x-auto pb-4 no-scrollbar">
                    <button onclick="filterCat('Tablet')" class="flex-shrink-0 bg-white p-4 rounded-2xl shadow-sm border border-gray-100 min-w-[110px] flex flex-col items-center gap-3 hover:border-teal-500 hover:shadow-md transition group">
                        <div class="bg-teal-50 w-12 h-12 rounded-full flex items-center justify-center group-hover:bg-teal-100 transition"><i class="fas fa-pills text-teal-600 text-xl"></i></div>
                        <span class="text-sm font-semibold text-gray-600 group-hover:text-teal-600">Tablets</span>
                    </button>
                    <button onclick="filterCat('Syrup')" class="flex-shrink-0 bg-white p-4 rounded-2xl shadow-sm border border-gray-100 min-w-[110px] flex flex-col items-center gap-3 hover:border-teal-500 hover:shadow-md transition group">
                        <div class="bg-orange-50 w-12 h-12 rounded-full flex items-center justify-center group-hover:bg-orange-100 transition"><i class="fas fa-prescription-bottle text-orange-500 text-xl"></i></div>
                        <span class="text-sm font-semibold text-gray-600 group-hover:text-orange-500">Syrups</span>
                    </button>
                    <button onclick="filterCat('Injection')" class="flex-shrink-0 bg-white p-4 rounded-2xl shadow-sm border border-gray-100 min-w-[110px] flex flex-col items-center gap-3 hover:border-teal-500 hover:shadow-md transition group">
                        <div class="bg-blue-50 w-12 h-12 rounded-full flex items-center justify-center group-hover:bg-blue-100 transition"><i class="fas fa-syringe text-blue-500 text-xl"></i></div>
                        <span class="text-sm font-semibold text-gray-600 group-hover:text-blue-500">Injections</span>
                    </button>
                    <button onclick="searchPublic()" class="flex-shrink-0 bg-white p-4 rounded-2xl shadow-sm border border-gray-100 min-w-[110px] flex flex-col items-center gap-3 hover:border-teal-500 hover:shadow-md transition group">
                        <div class="bg-gray-100 w-12 h-12 rounded-full flex items-center justify-center group-hover:bg-gray-200 transition"><i class="fas fa-th text-gray-600 text-xl"></i></div>
                        <span class="text-sm font-semibold text-gray-600">View All</span>
                    </button>
                </div>
            </div>

            <h3 class="font-bold text-xl mb-6 text-gray-800 px-1">Popular Near You</h3>
            <div id="publicGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
            <div id="mainLoader" class="text-center py-20 hidden"><div class="spinner border-teal-600 border-t-transparent w-10 h-10"></div><p class="text-gray-400 mt-3 text-sm">Finding best prices...</p></div>
        </section>

        <section id="view-myorders" class="container mx-auto px-4 py-8 hidden-section fade-in">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">My Orders</h2>
            <div class="flex gap-4 border-b border-gray-200 mb-6">
                <button onclick="filterMyOrders('Current')" id="tabMy-Current" class="pb-3 border-b-2 border-teal-600 font-bold text-teal-600 px-4 transition">Active</button>
                <button onclick="filterMyOrders('History')" id="tabMy-History" class="pb-3 border-b-2 border-transparent text-gray-500 hover:text-teal-600 px-4 transition">History</button>
            </div>
            <div id="myOrdersList" class="space-y-4 max-w-3xl mx-auto"></div>
        </section>

        <div id="stickyCart" class="fixed bottom-4 left-4 right-4 md:left-auto md:right-8 md:w-96 bg-gray-900 text-white rounded-2xl shadow-2xl p-4 flex justify-between items-center z-50 hidden cursor-pointer transform transition hover:scale-[1.02] active:scale-95" onclick="openCart()">
            <div class="flex flex-col">
                <div class="font-bold text-lg flex items-center gap-2"><span class="bg-teal-500 text-white w-6 h-6 rounded-full text-xs flex items-center justify-center" id="cartCount">0</span> Items</div>
                <div class="text-xs text-gray-400">Total + Delivery calculated at checkout</div>
            </div>
            <div class="font-bold text-teal-400 flex items-center gap-2 bg-gray-800 px-4 py-2 rounded-xl">View Cart <i class="fas fa-chevron-right text-xs"></i></div>
        </div>
    </div>

    <div id="app-admin" class="hidden-section flex h-screen bg-gray-50 overflow-hidden relative">
        <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden transition-opacity"></div>
        <aside id="adminSidebar" class="fixed inset-y-0 left-0 w-72 bg-white shadow-2xl transform -translate-x-full md:translate-x-0 md:static md:shadow-xl flex flex-col z-30 transition-transform duration-300 ease-in-out border-r border-gray-100">
            <div class="p-8 border-b border-gray-100 flex justify-between items-start">
                <div id="adminProfileInfo" class="animate-pulse">
                    <div class="h-6 bg-gray-200 rounded w-3/4 mb-3"></div>
                    <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                </div>
                <button onclick="toggleSidebar()" class="md:hidden text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            <nav class="flex-grow p-6 space-y-3">
                <button onclick="switchAdminView('products')" id="nav-products" class="w-full text-left p-4 rounded-xl bg-teal-50 text-teal-600 font-bold transition flex items-center gap-3"><i class="fas fa-box text-lg"></i> Inventory</button>
                <button onclick="switchAdminView('orders')" id="nav-orders" class="w-full text-left p-4 rounded-xl text-gray-500 hover:bg-gray-50 font-medium transition flex items-center gap-3"><i class="fas fa-clipboard-check text-lg"></i> Orders</button>
            </nav>
            <div class="p-6 border-t border-gray-100">
                <button onclick="logoutPartner()" class="w-full text-left p-3 text-red-500 hover:bg-red-50 rounded-xl font-bold transition flex items-center gap-2"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </aside>

        <div class="flex-grow flex flex-col h-screen overflow-hidden">
            <div class="md:hidden bg-white shadow-sm p-4 flex justify-between items-center z-10 sticky top-0">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()" class="text-gray-600 focus:outline-none p-2 rounded hover:bg-gray-100"><i class="fas fa-bars text-xl"></i></button>
                    <span class="font-bold text-teal-600 text-lg">Partner Dashboard</span>
                </div>
                <div class="w-8 h-8 bg-teal-100 rounded-full flex items-center justify-center text-teal-600 font-bold text-xs"><i class="fas fa-store"></i></div>
            </div>

            <main class="flex-grow overflow-y-auto p-4 md:p-10">
                <div id="admin-view-products" class="fade-in pb-20">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                        <h2 class="text-3xl font-bold text-gray-800">Inventory</h2>
                        <button onclick="openProductModal()" class="bg-teal-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-teal-700 shadow-lg flex items-center gap-2 w-full md:w-auto justify-center transition active:scale-95"><i class="fas fa-plus"></i> Add New Product</button>
                    </div>
                    <div class="relative mb-6">
                        <i class="fas fa-search absolute left-4 top-4 text-gray-400"></i>
                        <input type="text" id="adminProdSearch" onkeyup="filterAdminProducts()" placeholder="Search your products..." class="w-full pl-12 p-3 border border-gray-200 rounded-xl bg-white shadow-sm focus:ring-2 focus:ring-teal-500 outline-none">
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-200">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left min-w-[600px]">
                                <thead class="bg-gray-50 text-gray-500 text-xs uppercase font-bold tracking-wider">
                                    <tr><th class="p-5">Product Details</th><th class="p-5">Price</th><th class="p-5">Stock</th><th class="p-5 text-center">Actions</th></tr>
                                </thead>
                                <tbody id="adminProductTable" class="divide-y divide-gray-100 text-sm"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="admin-view-orders" class="hidden-section fade-in pb-20">
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="text-3xl font-bold text-gray-800">Orders</h2>
                        <button onclick="fetchAdminOrders()" class="text-teal-600 hover:bg-teal-50 px-4 py-2 rounded-lg transition font-bold"><i class="fas fa-sync-alt mr-1"></i> Sync</button>
                    </div>
                    <div class="flex gap-2 mb-6 border-b border-gray-200 overflow-x-auto pb-1">
                        <button onclick="filterAdminOrders('Active')" id="ordTab-Active" class="px-6 py-2 font-bold text-teal-600 border-b-2 border-teal-600 transition whitespace-nowrap">Current</button>
                        <button onclick="filterAdminOrders('Completed')" id="ordTab-Completed" class="px-6 py-2 font-bold text-gray-400 hover:text-teal-600 border-b-2 border-transparent transition whitespace-nowrap">Completed</button>
                        <button onclick="filterAdminOrders('Cancelled')" id="ordTab-Cancelled" class="px-6 py-2 font-bold text-gray-400 hover:text-teal-600 border-b-2 border-transparent transition whitespace-nowrap">Cancelled</button>
                    </div>
                    <input type="text" id="adminOrderSearch" onkeyup="renderAdminOrders()" placeholder="Search orders by ID or Name..." class="w-full p-3 border border-gray-200 rounded-xl mb-6 bg-white shadow-sm focus:ring-2 focus:ring-teal-500 outline-none">
                    <div id="adminOrderList" class="grid grid-cols-1 xl:grid-cols-2 gap-6"></div>
                </div>
            </main>
        </div>
    </div>

    <div id="partnerSuccessModal" class="fixed inset-0 hidden z-[60] flex items-center justify-center modal-overlay p-4">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md text-center fade-in border-t-8 border-teal-500">
            <div class="w-20 h-20 bg-teal-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-store text-teal-600 text-4xl"></i>
            </div>
            <h3 class="text-2xl font-extrabold text-gray-800 mb-2">Registration Successful!</h3>
            <p class="text-gray-500 text-sm mb-6">You are now a partner. Please save your Unique ID below to login.</p>
            <div class="bg-gray-100 p-4 rounded-xl mb-6 border border-gray-200">
                <p class="text-xs text-gray-500 uppercase font-bold tracking-wider mb-1">Your Store ID</p>
                <p id="regSuccessId" class="text-3xl font-mono font-bold text-teal-700 tracking-widest select-all">MED-XXXX</p>
            </div>
            <button onclick="finishPartnerReg()" class="w-full bg-teal-600 text-white py-3 rounded-xl font-bold hover:bg-teal-700 shadow-lg transition transform active:scale-95">Go to Login</button>
        </div>
    </div>

    <div id="cartModal" class="fixed inset-0 hidden z-50 flex items-end sm:items-center justify-center modal-overlay sm:p-4">
        <div class="bg-white w-full sm:max-w-lg h-[90vh] sm:h-auto sm:max-h-[85vh] flex flex-col rounded-t-3xl sm:rounded-3xl shadow-2xl fade-in transform transition-transform">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                <h3 class="font-bold text-xl text-gray-800">Your Cart</h3>
                <button onclick="closeModal('cartModal')" class="text-gray-400 hover:text-red-500 text-2xl transition">&times;</button>
            </div>
            <div id="cartContent" class="p-6 overflow-y-auto flex-grow bg-white space-y-4"></div>
            <div class="p-6 border-t border-gray-100 bg-gray-50 rounded-b-3xl">
                <div class="flex justify-between font-bold text-xl mb-4 text-gray-800"><span>To Pay</span><span id="cartTotal" class="text-teal-600">₹0</span></div>
                <button onclick="checkout()" id="btnCheckout" class="w-full bg-teal-600 text-white py-4 rounded-xl font-bold hover:bg-teal-700 transition shadow-lg text-lg">Place Order</button>
            </div>
        </div>
    </div>

    <div id="authModal" class="fixed inset-0 hidden z-50 flex items-center justify-center modal-overlay p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md relative fade-in">
            <button onclick="closeModal('authModal')" class="absolute top-5 right-5 text-gray-300 hover:text-gray-600 text-xl transition">&times;</button>
            <div id="authContent"></div>
        </div>
    </div>

    <div id="prodModal" class="fixed inset-0 hidden z-50 flex items-center justify-center modal-overlay p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto fade-in">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center sticky top-0 bg-white z-10">
                <h3 class="font-bold text-xl text-gray-800" id="prodModalTitle">Add Product</h3>
                <button onclick="closeModal('prodModal')" class="text-2xl text-gray-400 hover:text-red-500 transition">&times;</button>
            </div>
            <form id="prodForm" onsubmit="handleProdSave(event)" class="p-8 grid grid-cols-1 md:grid-cols-2 gap-6">
                <input type="hidden" name="product_id" id="f_pid"><input type="hidden" name="store_id" id="f_sid">
                <div class="md:col-span-2"><label class="text-xs font-bold uppercase text-gray-500 mb-1 block">Medicine Name</label><input name="medicine_name" id="f_name" required class="w-full border border-gray-300 p-3 rounded-xl focus:ring-2 focus:ring-teal-500 outline-none transition"></div>
                <div><label class="text-xs font-bold uppercase text-gray-500 mb-1 block">Category</label><input name="category" id="f_cat" list="cats" class="w-full border border-gray-300 p-3 rounded-xl focus:ring-2 focus:ring-teal-500 outline-none transition"><datalist id="cats"><option value="Tablet"><option value="Syrup"><option value="Injection"><option value="Equipment"></datalist></div>
                <div><label class="text-xs font-bold uppercase text-gray-500 mb-1 block">Price (₹)</label><input type="number" name="price" id="f_price" required class="w-full border border-gray-300 p-3 rounded-xl focus:ring-2 focus:ring-teal-500 outline-none transition"></div>
                <div class="md:col-span-2"><label class="text-xs font-bold uppercase text-gray-500 mb-1 block">Image URL</label><input type="url" name="image_url" id="f_img" class="w-full border border-gray-300 p-3 rounded-xl focus:ring-2 focus:ring-teal-500 outline-none transition" placeholder="https://..."></div>
                <div class="md:col-span-2"><label class="text-xs font-bold uppercase text-gray-500 mb-1 block">Description</label><textarea name="description" id="f_desc" rows="2" class="w-full border border-gray-300 p-3 rounded-xl focus:ring-2 focus:ring-teal-500 outline-none transition"></textarea></div>
                <div class="md:col-span-2"><label class="text-xs font-bold uppercase text-gray-500 mb-1 block">Private Notes</label><textarea name="private_notes" id="f_note" rows="1" class="w-full border border-gray-300 p-3 rounded-xl bg-yellow-50 focus:ring-2 focus:ring-yellow-400 outline-none transition"></textarea></div>
                <div class="md:col-span-2 bg-gray-50 p-3 rounded-xl"><label class="flex items-center gap-3 font-bold text-gray-700 cursor-pointer"><input type="checkbox" name="in_stock" id="f_stock" value="TRUE" checked class="w-5 h-5 text-teal-600 rounded focus:ring-teal-500"> Available in Stock</label></div>
                <div class="md:col-span-2"><button type="submit" id="btnSaveProd" class="w-full bg-teal-600 text-white p-4 rounded-xl font-bold hover:bg-teal-700 shadow-lg transition transform active:scale-95 text-lg">Save Product</button></div>
            </form>
        </div>
    </div>

    <div id="successModal" class="fixed inset-0 hidden z-50 flex items-center justify-center modal-overlay p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md text-center fade-in">
            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 text-green-600 text-4xl shadow-inner"><i class="fas fa-check"></i></div>
            <h3 class="text-2xl font-extrabold text-gray-800 mb-2">Order Placed!</h3>
            <p class="text-gray-500 text-sm mb-6">Your order has been sent to:</p>
            <div id="successDetails" class="bg-gray-50 rounded-xl p-5 text-left space-y-4 mb-6 max-h-60 overflow-y-auto border border-gray-200 shadow-inner"></div>
            <div class="bg-blue-50 text-blue-800 text-xs p-4 rounded-xl text-left border border-blue-100 flex gap-3 items-start">
                <i class="fas fa-info-circle text-lg mt-0.5"></i>
                <div><strong>Note:</strong> Pharmacies will contact you shortly to confirm delivery/pickup.</div>
            </div>
            <button onclick="closeModal('successModal')" class="mt-6 w-full bg-teal-600 text-white py-3 rounded-xl font-bold hover:bg-teal-700 transition shadow-lg">Okay, Got it</button>
        </div>
    </div>

    <script>
        // *** CONFIG ***
        const API = 'https://script.google.com/macros/s/AKfycbyvl7ezlg-g-u0XUCTkIEFjBs8Nm6gFA5vNy7EVINSF0WRlkPqTHnKUefnSSPsGLyc1lA/exec';
        const KEY_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQY2BokImG-lKK2HjjAPxJIi2kwTLVuELWKB8BQXDEFRjG5cXn4Tj0x_qivopk9DPCCBBGDUF06FBvU/pub?output=csv';
        
        let GEMINI_API_KEY = null;

        function fetchApiKey() {
            return new Promise((resolve, reject) => {
                Papa.parse(KEY_CSV, {
                    download: true,
                    header: false,
                    complete: function(results) {
                        // Look for 'Gemini' in column 0, Key in column 1
                        if (results.data) {
                            for (let row of results.data) {
                                if (row[0] && row[0].trim() === 'Gemini' && row[1]) {
                                    GEMINI_API_KEY = row[1].trim();
                                    console.log("MediPlus AI: Key Loaded Successfully via PapaParse");
                                    resolve(GEMINI_API_KEY);
                                    return;
                                }
                            }
                        }
                        console.error("MediPlus AI: Key not found in CSV");
                        reject(new Error("Key not found"));
                    },
                    error: function(err) {
                        console.error("MediPlus AI: CSV Fetch Error", err);
                        reject(err);
                    }
                });
            });
        }

        // *** ROBUST API CALLER WITH MODEL SWITCHING ***
        // 1. Tries gemini-1.5-flash-latest (specific)
        // 2. If 404, automatically tries gemini-pro (fallback)
        // *** ROBUST API CALLER WITH MODEL SWITCHING ***
        async function fetchWithBackoff(payload) {
            const models = ['gemini-1.5-flash', 'gemini-pro']; 
            let lastError = null;
            
            for (const model of models) {const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${GEMINI_API_KEY}`;
                // const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`;
                
                
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) return await response.json();
                    
                    if (response.status === 404) {
                        console.warn(`Model ${model} not found (404). Switching...`);
                        lastError = new Error("404 API Not Enabled");
                        continue; // Try next model
                    }

                    const errText = await response.text();
                    throw new Error(`API Error ${response.status}: ${errText}`);

                } catch (error) {
                    console.error(`Attempt failed for ${model}:`, error);
                    lastError = error;
                }
            }
            // If we loop through all models and fail, throw the last error
            throw lastError || new Error("All models failed.");
        }
        // *** STATE ***
        let rawProducts=[], cart=[], user=null, partnerId=null, partnerName='Partner';
        let rawAdminProducts=[], rawAdminOrders=[], rawCustomerOrders=[];
        let activeAdminOrderTab = 'Active';

        // *** INIT ***
        window.onload = async () => {
            try {
                await fetchApiKey(); 
            } catch(e) {
                console.error("Failed to init AI key", e);
            }
            
            if(localStorage.getItem('mediUser')) user=JSON.parse(localStorage.getItem('mediUser'));
            updateAuthUI();
            loadHome();
        };

        // --- PUBLIC FUNCTIONS ---
        async function loadHome() {
            document.getElementById('mainLoader').classList.remove('hidden');
            try {
                const res = await fetch(`${API}?action=get_all_data`);
                const d = await res.json();
                rawProducts = d.products || [];
                renderPublicGrid(rawProducts);
            } catch(e) { toast('Error loading data', 'error'); }
            document.getElementById('mainLoader').classList.add('hidden');
        }

        function filterCat(cat) {
            renderPublicGrid(rawProducts.filter(p => p.category === cat));
        }

        function renderPublicGrid(list) {
            const div = document.getElementById('publicGrid'); div.innerHTML = '';
            if(!list.length) return div.innerHTML='<p class="col-span-full text-center text-gray-400 py-10 italic">No medicines found matching your criteria.</p>';
            
            list.forEach(p => {
                const stock = p.in_stock==='TRUE'||p.in_stock===true;
                const img = p.image || 'https://via.placeholder.com/300?text=No+Image';
                div.innerHTML += `
                    <div class="bg-white rounded-2xl shadow-sm hover:shadow-xl transition-all duration-300 border border-gray-100 overflow-hidden flex flex-col group relative">
                        ${!stock ? '<span class="absolute top-3 left-3 bg-gray-800 text-white text-xs font-bold px-3 py-1 rounded-full z-10 opacity-80 backdrop-blur-sm">Out of Stock</span>' : '<span class="absolute top-3 right-3 bg-green-100 text-green-700 text-[10px] font-bold px-2 py-1 rounded-lg z-10 uppercase tracking-wide">In Stock</span>'}
                        <div class="h-48 overflow-hidden bg-gray-50 relative">
                            <img src="${img}" class="w-full h-full object-cover group-hover:scale-110 transition duration-700" onerror="this.src='https://via.placeholder.com/300?text=Image+Error'">
                        </div>
                        <div class="p-5 flex-grow flex flex-col">
                            <h3 class="font-bold text-gray-800 text-lg mb-1 leading-tight line-clamp-1 group-hover:text-teal-600 transition">${p.name}</h3>
                            <p class="text-xs text-gray-500 mb-3 truncate bg-gray-50 inline-block px-2 py-1 rounded w-fit">${p.category}</p>
                            <div class="flex items-center text-xs text-gray-400 mb-4"><i class="fas fa-store-alt mr-2 text-teal-500"></i> ${p.store_name}</div>
                            <div class="mt-auto flex justify-between items-center pt-4 border-t border-gray-50">
                                <span class="font-extrabold text-xl text-gray-800">₹${p.price}</span>
                                <button onclick='addToCart(${JSON.stringify(p)})' ${!stock?'disabled':''} class="${stock?'bg-teal-600 text-white hover:bg-teal-700 shadow-md hover:shadow-lg':'bg-gray-100 text-gray-400 cursor-not-allowed'} px-4 py-2 rounded-xl font-bold transition transform active:scale-95 text-sm flex items-center gap-2">
                                    ${stock ? '<i class="fas fa-plus"></i> ADD' : 'Unavailable'}
                                </button>
                            </div>
                        </div>
                    </div>`;
            });
        }
        function searchPublic() { const q=document.getElementById('publicSearch').value.toLowerCase(); renderPublicGrid(rawProducts.filter(p=>p.name.toLowerCase().includes(q)||p.category.toLowerCase().includes(q)||p.store_name.toLowerCase().includes(q))); }

        // --- GEMINI AI LOGIC (UPDATED) ---
        function toggleAiChat() {
            const w = document.getElementById('aiChatWindow');
            if(w.classList.contains('hidden')) {
                w.classList.remove('hidden');
                document.getElementById('aiInput').focus();
            } else {
                w.classList.add('hidden');
            }
        }

        function handleAiEnter(e) {
            if(e.key === 'Enter') sendAiMessage();
        }

        async function sendAiMessage() {
            // 1. Check if key is loaded
            if(!GEMINI_API_KEY) {
                addChatBubble("<b>System:</b> Connecting to AI services...", 'ai');
                try {
                    await fetchApiKey();
                    if(!GEMINI_API_KEY) throw new Error("Key not found");
                } catch(e) {
                    addChatBubble("System Error: Could not load API Key.", 'ai');
                    return;
                }
            }

            const input = document.getElementById('aiInput');
            const msg = input.value.trim();
            if(!msg) return;

            // 2. Add User Message
            addChatBubble(msg, 'user');
            input.value = '';
            document.getElementById('aiTyping').classList.remove('hidden');
            const msgsDiv = document.getElementById('aiMessages');
            msgsDiv.scrollTop = msgsDiv.scrollHeight;

            // 3. Prepare Context
            const stockContext = rawProducts && rawProducts.length > 0 
                ? rawProducts.map(p => `${p.name} (₹${p.price})`).join(', ')
                : "No products currently loaded.";

            const prompt = `
                You are a helpful Medical Assistant for "MediPlus".
                Current Stock: [${stockContext}]
                Emergency Contact: +917021360582
                User Question: "${msg}"
                Answer briefly. If medicine is not in stock, tell them to call the contact number.
                Always end with: "I am an AI. Consult a doctor for medical advice. +918850102255 +918268400523"
            `;

            try {
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                const data = await fetchWithBackoff(payload);
                
                document.getElementById('aiTyping').classList.add('hidden');

                if (data && data.candidates && data.candidates[0].content) {
                    const aiText = data.candidates[0].content.parts[0].text;
                    addChatBubble(aiText, 'ai');
                } else {
                    addChatBubble("I didn't get a valid response. Please try again.", 'ai');
                }

            } catch (error) {
                console.error("AI Error:", error);
                document.getElementById('aiTyping').classList.add('hidden');
                
                if(error.message.includes("404")) {
                    addChatBubble(`
                        <b>System Error:</b> API Permission is OFF.<br>
                        Your API Key is valid, but the "Generative Language API" is disabled for this project.<br><br>
                        <b>Solution:</b><br>
                        1. Go to <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 underline">Google AI Studio</a>.<br>
                        2. Click "Create API Key".<br>
                        3. Select <b>"Create API key in NEW project"</b> (Do not select an existing project).<br>
                        4. Paste the new key into your Google Sheet.
                    `, 'ai');
                } else {
                    addChatBubble("Connection error. Please check your internet.", 'ai');
                }
            }
        }

        function addChatBubble(text, sender) {
            const div = document.getElementById('aiMessages');
            const isAi = sender === 'ai';
            const content = isAi ? marked.parse(text) : text;

            const html = `
                <div class="flex gap-3 ${isAi ? '' : 'flex-row-reverse'}">
                    <div class="w-8 h-8 rounded-full ${isAi ? 'bg-teal-100 text-teal-600' : 'bg-gray-800 text-white'} flex-shrink-0 flex items-center justify-center text-xs">
                        <i class="fas ${isAi ? 'fa-robot' : 'fa-user'}"></i>
                    </div>
                    <div class="${isAi ? 'bg-white text-gray-700 rounded-tl-none border border-gray-100' : 'bg-teal-600 text-white rounded-tr-none'} p-3 rounded-2xl shadow-sm text-sm max-w-[80%]">
                        <div class="prose prose-sm ${isAi ? '' : 'text-white'}">${content}</div>
                    </div>
                </div>
            `;
            div.insertAdjacentHTML('beforeend', html);
            div.scrollTop = div.scrollHeight;
        }

        // --- CART ---
        function addToCart(p) { cart.push(p); updateCartUI(); toast('Added to Cart'); }
        function updateCartUI() {
            const count = cart.length;
            document.getElementById('cartCount').innerText = count;
            const bar = document.getElementById('stickyCart');
            if(count > 0) { bar.classList.remove('hidden'); bar.classList.add('flex'); } 
            else { bar.classList.add('hidden'); bar.classList.remove('flex'); }
        }
        function openCart() {
            document.getElementById('cartModal').classList.remove('hidden');
            const div = document.getElementById('cartContent'); div.innerHTML=''; let t=0;
            if(!cart.length) div.innerHTML='<div class="text-center py-10"><i class="fas fa-shopping-basket text-4xl text-gray-200 mb-3"></i><p class="text-gray-400">Your cart is empty.</p></div>';
            cart.forEach((i,x) => { t+=Number(i.price);
                div.innerHTML += `
                <div class="flex justify-between items-center bg-white p-4 rounded-2xl border border-gray-100 shadow-sm hover:shadow-md transition">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-teal-50 rounded-lg flex items-center justify-center text-teal-600"><i class="fas fa-prescription-bottle-alt"></i></div>
                        <div><b class="text-gray-800 text-sm block">${i.name}</b><span class="text-xs text-gray-500">${i.store_name}</span></div>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="font-bold text-gray-800">₹${i.price}</span>
                        <button class="text-red-400 hover:text-red-600 hover:bg-red-50 p-2 rounded-full transition" onclick="cart.splice(${x},1);openCart();updateCartUI()"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>`;
            });
            document.getElementById('cartTotal').innerText = '₹'+t;
        }

        async function checkout() {
            if(!user) { closeModal('cartModal'); return openAuth('login'); }
            if(!cart.length) return;
            setLoading('btnCheckout', true);
            const orders = {}; cart.forEach(i => { if(!orders[i.store_id]) orders[i.store_id]=[]; orders[i.store_id].push(i); });
            const successData = [];
            for(const sid in orders) {
                const items = orders[sid];
                const total = items.reduce((s,i)=>s+Number(i.price),0);
                const res = await fetch(API, {method:'POST', body:JSON.stringify({action:'place_order', store_id:sid, customer_name:user.name, customer_phone:user.phone, customer_address:user.address, order_items: JSON.stringify(items.map(x=>({name:x.name, price:x.price}))), total_amount: total})});
                const d = await res.json();
                if(d.status==='success') successData.push({store:d.store_name, phone:d.store_phone, items:items.length});
            }
            setLoading('btnCheckout', false); cart=[]; updateCartUI(); closeModal('cartModal');
            const detDiv = document.getElementById('successDetails'); detDiv.innerHTML='';
            successData.forEach(s => { detDiv.innerHTML += `
            <div class="border-b border-gray-100 last:border-0 pb-3 mb-3">
                <p class="font-bold text-gray-800 text-lg">${s.store}</p>
                <p class="text-xs text-gray-500 mb-2">Items Ordered: ${s.items}</p>
                <a href="tel:${s.phone}" class="inline-flex items-center gap-2 text-teal-600 text-xs font-bold bg-teal-50 px-3 py-1 rounded-full"><i class="fas fa-phone-alt"></i> ${s.phone}</a>
            </div>`; });
            document.getElementById('successModal').classList.remove('hidden');
        }

        // --- CUSTOMER ORDERS ---
        async function loadCustomerOrders() {
            showPublicHome();
            document.getElementById('view-home').classList.add('hidden-section');
            document.getElementById('view-myorders').classList.remove('hidden-section');
            const div = document.getElementById('myOrdersList'); div.innerHTML='<div class="text-center py-20"><div class="spinner border-teal-600"></div><p class="mt-2 text-gray-500">Fetching your history...</p></div>';
            const res = await fetch(`${API}?action=get_customer_orders&phone=${user.phone}`);
            const d = await res.json();
            rawCustomerOrders = d.orders || [];
            filterMyOrders('Current');
        }

        function filterMyOrders(type) {
            document.getElementById('tabMy-Current').className = type==='Current' ? 'pb-3 border-b-2 border-teal-600 font-bold text-teal-600 px-4 transition' : 'pb-3 border-b-2 border-transparent text-gray-500 hover:text-teal-600 px-4 transition';
            document.getElementById('tabMy-History').className = type==='History' ? 'pb-3 border-b-2 border-teal-600 font-bold text-teal-600 px-4' : 'pb-3 border-b-2 border-transparent text-gray-500 hover:text-teal-600 px-4 transition';
            const div = document.getElementById('myOrdersList'); div.innerHTML='';
            const list = rawCustomerOrders.filter(o => type==='Current' ? (o.status==='Pending'||o.status==='Approved') : (o.status!=='Pending'&&o.status!=='Approved'));
            if(!list.length) return div.innerHTML=`<div class="text-center py-10 bg-white rounded-2xl border border-gray-100 shadow-sm"><i class="fas fa-box-open text-4xl text-gray-200 mb-3"></i><p class="text-gray-400">No ${type.toLowerCase()} orders.</p></div>`;
            list.forEach(o => {
                const items = JSON.parse(o.items).map(i=>i.name).join(', ');
                let badge = 'bg-yellow-100 text-yellow-800';
                if(o.status==='Approved') badge='bg-blue-100 text-blue-800';
                if(o.status==='Delivered') badge='bg-green-100 text-green-800';
                if(o.status==='Cancelled') badge='bg-red-100 text-red-800';
                div.innerHTML += `
                    <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm hover:shadow-lg transition duration-300">
                        <div class="flex justify-between items-center mb-4">
                            <span class="font-mono text-gray-500 text-xs">#${o.order_id}</span>
                            <span class="${badge} px-3 py-1 rounded-full text-[10px] font-extrabold uppercase tracking-widest shadow-sm">${o.status}</span>
                        </div>
                        <div class="flex items-start gap-4 mb-4">
                            <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-gray-500"><i class="fas fa-store"></i></div>
                            <div>
                                <p class="font-bold text-gray-800 text-lg">${o.store_name}</p>
                                <a href="tel:${o.store_phone}" class="text-xs text-teal-600 font-bold hover:underline"><i class="fas fa-phone-alt mr-1"></i> ${o.store_phone}</a>
                            </div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-xl mb-4 text-sm text-gray-600 leading-relaxed border border-gray-100">
                            ${items}
                        </div>
                        <div class="pt-4 border-t border-gray-100 flex justify-between items-center">
                            <span class="text-xs text-gray-400">${new Date(o.date).toLocaleDateString()}</span>
                            <span class="text-xl font-extrabold text-gray-800">₹${o.total}</span>
                        </div>
                    </div>`;
            });
        }

        // ==========================================
        // ADMIN LOGIC
        // ==========================================
        function toggleSidebar() {
            const sidebar = document.getElementById('adminSidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if(sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        async function loadAdminData() {
            document.getElementById('app-public').classList.add('hidden-section');
            document.getElementById('app-admin').classList.remove('hidden-section');
            // DISPLAY PARTNER NAME & ID
            document.getElementById('adminProfileInfo').innerHTML = `<h2 class="font-bold text-xl text-gray-800">${partnerName}</h2><p class="text-xs text-gray-500 font-mono mt-1 bg-gray-100 p-1 px-2 rounded inline-block tracking-wider">ID: ${partnerId}</p>`;
            document.getElementById('adminProfileInfo').classList.remove('animate-pulse');
            document.getElementById('f_sid').value = partnerId;
            fetchAdminProducts();
        }

        async function fetchAdminProducts(){
            document.getElementById('adminProductTable').innerHTML='<tr><td colspan="4" class="p-10 text-center"><div class="spinner spinner-dark"></div> Loading Inventory...</td></tr>';
            const res=await fetch(`${API}?action=get_store_products&store_id=${partnerId}`); const d=await res.json(); rawAdminProducts=d.products||[]; renderAdminProducts();
        }

        function renderAdminProducts(){
            const q=document.getElementById('adminProdSearch').value.toLowerCase(); const t=document.getElementById('adminProductTable'); t.innerHTML='';
            rawAdminProducts.filter(p=>p.name.toLowerCase().includes(q)).forEach(p=>{
                const stk = p.in_stock==='TRUE'||p.in_stock===true;
                const img = p.image || 'https://via.placeholder.com/100?text=No+Img';
                t.innerHTML+=`
                <tr class="border-b last:border-0 hover:bg-gray-50 transition">
                    <td class="p-5 flex items-center gap-4">
                        <img src="${img}" class="w-12 h-12 rounded-xl object-cover border border-gray-100 shadow-sm" onerror="this.src='https://via.placeholder.com/100?text=Error'">
                        <div><div class="font-bold text-gray-800">${p.name}</div><div class="text-xs text-gray-500">${p.category}</div></div>
                    </td>
                    <td class="p-5 font-bold text-gray-700">₹${p.price}</td>
                    <td class="p-5"><button onclick="toggleStock('${p.id}',${!stk})" class="${stk?'bg-green-100 text-green-700 border border-green-200':'bg-red-100 text-red-700 border border-red-200'} text-xs font-bold px-3 py-1 rounded-full w-24 text-center transition hover:shadow-md">${stk?'In Stock':'Stock Out'}</button></td>
                    <td class="p-5 text-center">
                        <button onclick='openProductModal(${JSON.stringify(p)})' class="text-teal-600 hover:bg-teal-50 p-2 rounded-full mr-2 transition"><i class="fas fa-edit"></i></button>
                        <button onclick="delProd('${p.id}')" class="text-red-400 hover:bg-red-50 p-2 rounded-full transition"><i class="fas fa-trash-alt"></i></button>
                    </td>
                </tr>`;
            });
        }

        async function fetchAdminOrders() {
            document.getElementById('adminOrderList').innerHTML='<div class="text-center py-20 col-span-2"><div class="spinner spinner-dark"></div> Syncing Orders...</div>';
            const res = await fetch(`${API}?action=get_store_orders&store_id=${partnerId}`);
            const d = await res.json();
            rawAdminOrders = d.orders || [];
            filterAdminOrders(activeAdminOrderTab);
        }

        function filterAdminOrders(tab) {
            activeAdminOrderTab = tab;
            ['Active','Completed','Cancelled'].forEach(t => {
                const btn = document.getElementById(`ordTab-${t}`);
                if(t === tab) btn.className = "px-6 py-2 font-bold text-teal-600 border-b-2 border-teal-600 transition whitespace-nowrap bg-teal-50 rounded-t-lg";
                else btn.className = "px-6 py-2 font-bold text-gray-400 hover:text-teal-600 border-b-2 border-transparent transition whitespace-nowrap";
            });
            renderAdminOrders();
        }

        function renderAdminOrders() {
            const q = document.getElementById('adminOrderSearch').value.toLowerCase();
            const div = document.getElementById('adminOrderList'); div.innerHTML='';
            let list = [];
            if(activeAdminOrderTab === 'Active') list = rawAdminOrders.filter(o => o.status==='Pending' || o.status==='Approved');
            else if(activeAdminOrderTab === 'Completed') list = rawAdminOrders.filter(o => o.status==='Delivered');
            else list = rawAdminOrders.filter(o => o.status==='Cancelled' || o.status==='Refused');
            list = list.filter(o => o.customer_name.toLowerCase().includes(q) || o.order_id.toLowerCase().includes(q));

            if(!list.length) return div.innerHTML = '<div class="col-span-2 text-center py-20 bg-white rounded-3xl border border-dashed border-gray-300"><i class="fas fa-clipboard-list text-4xl text-gray-200 mb-4"></i><p class="text-gray-400">No orders found here.</p></div>';

            list.forEach(o => {
                const items = JSON.parse(o.items).map(i=>`<div class="flex justify-between text-sm py-2 border-b border-dashed border-gray-100 last:border-0"><span class="text-gray-600">${i.name}</span><span class="font-bold text-gray-800">₹${i.price}</span></div>`).join('');
                let actions = '';
                if(o.status === 'Pending') actions = `<div class="grid grid-cols-2 gap-3 mt-5"><button onclick="setStatus('${o.order_id}','Approved')" class="bg-teal-600 text-white py-3 rounded-xl text-sm font-bold hover:bg-teal-700 shadow-md transition transform active:scale-95">Approve</button><button onclick="setStatus('${o.order_id}','Cancelled')" class="bg-red-50 text-red-600 py-3 rounded-xl text-sm font-bold hover:bg-red-100 transition">Refuse</button></div>`;
                else if (o.status === 'Approved') actions = `<div class="grid grid-cols-2 gap-3 mt-5"><button onclick="setStatus('${o.order_id}','Delivered')" class="bg-green-600 text-white py-3 rounded-xl text-sm font-bold hover:bg-green-700 shadow-sm transition transform active:scale-95">Deliver</button><button onclick="setStatus('${o.order_id}','Cancelled')" class="bg-red-50 text-red-600 py-3 rounded-xl text-sm font-bold hover:bg-red-100 transition">Cancel</button></div>`;

                div.innerHTML += `
                    <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm hover:shadow-xl transition duration-300">
                        <div class="flex justify-between items-start mb-4">
                            <div><div class="font-bold text-teal-700 text-lg">${o.customer_name}</div><div class="text-xs text-gray-400 font-mono mt-1">${o.order_id}</div></div>
                            <a href="tel:${o.customer_phone}" class="bg-teal-50 text-teal-600 w-10 h-10 rounded-full flex items-center justify-center hover:bg-teal-100 transition"><i class="fas fa-phone-alt"></i></a>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-xl text-xs text-gray-600 mb-4 border border-gray-100 flex gap-2"><i class="fas fa-map-marker-alt text-teal-500 mt-0.5"></i> <span>${o.customer_address}</span></div>
                        <div class="mb-4 bg-white border border-gray-100 rounded-xl p-3">${items}</div>
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-gray-400 font-bold uppercase tracking-wider">Total Bill</span>
                            <span class="text-2xl font-extrabold text-gray-800">₹${o.total}</span>
                        </div>
                        ${actions}
                    </div>`;
            });
        }

        async function setStatus(oid, status) {
            const order = rawAdminOrders.find(o => o.order_id === oid);
            if(order) order.status = status;
            renderAdminOrders(); 
            await fetch(API, {method:'POST', body:JSON.stringify({action:'update_order_status', store_id:partnerId, order_id:oid, status:status})});
            toast(`Order marked as ${status}`);
        }

        // --- AUTH & HELPERS ---
        function updateAuthUI() {
            const d = document.getElementById('authContainer');
            if(user) d.innerHTML = `<span class="text-sm font-bold text-gray-700 mr-2 hidden md:inline">Hi, ${user.name.split(' ')[0]}</span><button onclick="loadCustomerOrders()" class="text-sm font-bold text-teal-600 hover:text-teal-800 transition">My Orders</button><button onclick="logoutUser()" class="text-sm text-red-500 font-bold ml-3 hover:text-red-700 transition">Logout</button>`;
            else d.innerHTML = `<button onclick="openAuth('login')" class="font-bold text-sm text-teal-600 hover:text-teal-800 transition mr-2">Login</button><button onclick="openAuth('partner')" class="bg-gray-900 text-white text-xs px-4 py-2 rounded-full shadow-lg hover:bg-gray-800 transition transform hover:scale-105">Partner</button>`;
        }
        
        function openAuth(type) {
            document.getElementById('authModal').classList.remove('hidden'); const c = document.getElementById('authContent');
            if(type==='login') c.innerHTML=`<h3 class="font-bold text-2xl mb-1 text-gray-800">Welcome Back</h3><p class="text-sm text-gray-400 mb-6">Login to continue ordering</p><form onsubmit="doLogin(event)"><input name="phone" placeholder="Mobile Number" required class="w-full border border-gray-200 p-4 rounded-xl mb-3 outline-none focus:ring-2 focus:ring-teal-500 bg-gray-50 focus:bg-white transition"><input type="password" name="password" placeholder="Password" required class="w-full border border-gray-200 p-4 rounded-xl mb-6 outline-none focus:ring-2 focus:ring-teal-500 bg-gray-50 focus:bg-white transition"><button id="btnLogin" class="w-full bg-teal-600 text-white p-4 rounded-xl font-bold hover:bg-teal-700 transition shadow-lg text-lg">Login</button></form><p class="mt-6 text-center text-sm text-gray-500">New to MediPlus? <span class="text-teal-600 font-bold cursor-pointer hover:underline" onclick="openAuth('register')">Create Account</span></p>`;
            if(type==='register') c.innerHTML=`<h3 class="font-bold text-2xl mb-1 text-gray-800">Create Account</h3><p class="text-sm text-gray-400 mb-6">Join us for fast delivery</p><form onsubmit="doReg(event)"><input name="name" placeholder="Full Name" required class="w-full border border-gray-200 p-4 rounded-xl mb-3 bg-gray-50 focus:bg-white outline-none focus:ring-2 focus:ring-teal-500"><input name="phone" placeholder="Phone Number" required class="w-full border border-gray-200 p-4 rounded-xl mb-3 bg-gray-50 focus:bg-white outline-none focus:ring-2 focus:ring-teal-500"><input type="password" name="password" placeholder="Set Password" required class="w-full border border-gray-200 p-4 rounded-xl mb-3 bg-gray-50 focus:bg-white outline-none focus:ring-2 focus:ring-teal-500"><input name="address" placeholder="Delivery Address" required class="w-full border border-gray-200 p-4 rounded-xl mb-6 bg-gray-50 focus:bg-white outline-none focus:ring-2 focus:ring-teal-500"><button id="btnReg" class="w-full bg-teal-600 text-white p-4 rounded-xl font-bold hover:bg-teal-700 transition shadow-lg text-lg">Sign Up</button></form><p class="mt-6 text-center text-sm text-gray-500">Already have an account? <span class="text-teal-600 font-bold cursor-pointer hover:underline" onclick="openAuth('login')">Login</span></p>`;
            if(type==='partner') c.innerHTML=`<h3 class="font-bold text-2xl mb-1 text-gray-800">Partner Login</h3><p class="text-sm text-gray-400 mb-6">Manage your pharmacy</p><form onsubmit="doPLogin(event)"><input id="pidIn" placeholder="Store ID (e.g. MED-1001)" required class="w-full border border-gray-200 p-4 rounded-xl mb-3 text-center uppercase tracking-widest font-mono text-lg bg-gray-50 focus:bg-white outline-none focus:ring-2 focus:ring-teal-500"><input id="pPhoneIn" placeholder="Registered Mobile" required class="w-full border border-gray-200 p-4 rounded-xl mb-6 text-center text-lg bg-gray-50 focus:bg-white outline-none focus:ring-2 focus:ring-teal-500"><button id="btnPLogin" class="w-full bg-gray-900 text-white p-4 rounded-xl font-bold hover:bg-gray-800 transition shadow-lg text-lg">Access Dashboard</button></form><div class="mt-8 pt-6 border-t border-gray-100 text-center"><p class="text-sm text-gray-500 mb-3">Want to become a partner?</p><form onsubmit="doPReg(event)" class="text-left hidden bg-gray-50 p-4 rounded-xl border border-gray-100 animate-fade-in-up" id="pRegForm"><input name="store_name" placeholder="Pharmacy Name" required class="w-full border p-3 rounded-lg mb-2"><input name="owner_name" placeholder="Owner Name" required class="w-full border p-3 rounded-lg mb-2"><input name="phone" placeholder="Phone" required class="w-full border p-3 rounded-lg mb-2"><input name="city" placeholder="City" required class="w-full border p-3 rounded-lg mb-2"><input name="address" placeholder="Full Address" required class="w-full border p-3 rounded-lg mb-3"><button id="btnPReg" class="w-full bg-teal-600 text-white p-3 rounded-lg font-bold">Register Now</button></form><button onclick="document.getElementById('pRegForm').classList.remove('hidden');this.classList.add('hidden')" class="text-teal-600 font-bold text-sm border border-teal-200 px-4 py-2 rounded-full hover:bg-teal-50 transition">Register New Store</button></div>`;
        }

        async function doLogin(e) { e.preventDefault(); setLoading('btnLogin',true); const d=Object.fromEntries(new FormData(e.target)); d.action='login_customer'; const res=await fetch(API,{method:'POST',body:JSON.stringify(d)}); const j=await res.json(); setLoading('btnLogin',false); if(j.status==='success'){ user=j.customer_data; localStorage.setItem('mediUser',JSON.stringify(user)); updateAuthUI(); closeModal('authModal'); toast('Welcome back'); } else toast('Invalid credentials','error'); }
        async function doReg(e) { e.preventDefault(); setLoading('btnReg',true); const d=Object.fromEntries(new FormData(e.target)); d.action='register_customer'; const res=await fetch(API,{method:'POST',body:JSON.stringify(d)}); const j=await res.json(); setLoading('btnReg',false); if(j.status==='success'){ user=j; localStorage.setItem('mediUser',JSON.stringify(user)); updateAuthUI(); closeModal('authModal'); toast('Account created'); } }
        
        async function doPLogin(e) { 
            e.preventDefault(); 
            setLoading('btnPLogin',true); 
            const id = document.getElementById('pidIn').value;
            const phone = document.getElementById('pPhoneIn').value;
            
            const res = await fetch(API, {
                method:'POST',
                body:JSON.stringify({
                    action:'login_store',
                    store_id: id,
                    phone: phone
                })
            }); 
            
            const j=await res.json(); 
            setLoading('btnPLogin',false); 
            
            if(j.status==='success'){ 
                partnerId=j.store_data.id; 
                partnerName=j.store_data.name; 
                loadAdminData(); 
                closeModal('authModal'); 
                toast('Logged in as Partner'); 
            } else { 
                toast(j.message,'error'); 
            } 
        }
        
        async function doPReg(e) { 
            e.preventDefault(); 
            setLoading('btnPReg',true); 
            const d=Object.fromEntries(new FormData(e.target)); 
            d.action='register_store'; 
            const res=await fetch(API,{method:'POST',body:JSON.stringify(d)}); 
            const j=await res.json(); 
            setLoading('btnPReg',false); 
            
            if(j.status === 'error') {
                toast(j.message, 'error');
            } else {
                closeModal('authModal');
                document.getElementById('regSuccessId').innerText = j.store_id;
                document.getElementById('partnerSuccessModal').classList.remove('hidden');
            }
        }

        function finishPartnerReg() {
            closeModal('partnerSuccessModal');
            openAuth('partner'); // Re-open login for them to enter ID
        }

        function switchAdminView(v) {
            document.getElementById('admin-view-products').classList.add('hidden-section'); document.getElementById('admin-view-orders').classList.add('hidden-section');
            document.getElementById(`admin-view-${v}`).classList.remove('hidden-section');
            document.getElementById('nav-products').className = v==='products'?'w-full text-left p-4 rounded-xl bg-teal-50 text-teal-600 font-bold transition flex items-center gap-3':'w-full text-left p-4 rounded-xl text-gray-500 hover:bg-gray-50 font-medium transition flex items-center gap-3';
            document.getElementById('nav-orders').className = v==='orders'?'w-full text-left p-4 rounded-xl bg-teal-50 text-teal-600 font-bold transition flex items-center gap-3':'w-full text-left p-4 rounded-xl text-gray-500 hover:bg-gray-50 font-medium transition flex items-center gap-3';
            if(v==='orders') fetchAdminOrders();
            // Close mobile menu if open
            const sidebar = document.getElementById('adminSidebar');
            if(!sidebar.classList.contains('-translate-x-full')) toggleSidebar();
        }
        
        async function handleProdSave(e) { e.preventDefault(); setLoading('btnSaveProd',true); const d=Object.fromEntries(new FormData(e.target)); d.action=d.product_id?'edit_product':'add_product'; d.in_stock=document.getElementById('f_stock').checked?'TRUE':'FALSE'; await fetch(API,{method:'POST',body:JSON.stringify(d)}); setLoading('btnSaveProd',false); closeModal('prodModal'); fetchAdminProducts(); toast('Product Saved'); }
        function openProductModal(p=null) { document.getElementById('prodModal').classList.remove('hidden'); document.getElementById('prodForm').reset(); document.getElementById('prodModalTitle').innerText = p?'Edit Product':'Add Product'; document.getElementById('f_pid').value = p?p.id:''; document.getElementById('f_sid').value = partnerId; if(p){ document.getElementById('f_name').value=p.name; document.getElementById('f_cat').value=p.category; document.getElementById('f_price').value=p.price; document.getElementById('f_img').value=p.image; document.getElementById('f_desc').value=p.description; document.getElementById('f_note').value=p.private_notes; document.getElementById('f_stock').checked=(p.in_stock==='TRUE'||p.in_stock===true); } }
        async function toggleStock(pid, s) { rawAdminProducts.find(p=>p.id===pid).in_stock=s; renderAdminProducts(); await fetch(API,{method:'POST',body:JSON.stringify({action:'edit_product',product_id:pid,store_id:partnerId,only_stock:true,in_stock:s})}); toast('Stock updated'); }
        async function delProd(pid) { if(!confirm('Delete?'))return; await fetch(API,{method:'POST',body:JSON.stringify({action:'delete_product',product_id:pid,store_id:partnerId})}); fetchAdminProducts(); toast('Deleted'); }

        // --- UTILS ---
        function toast(m,t='s'){const d=document.createElement('div');d.className=`p-4 px-6 rounded-xl shadow-2xl text-white text-sm font-bold animate-bounce ${t==='s'?'bg-gray-800':'bg-red-500'}`;d.innerHTML=t==='s'?`<i class="fas fa-check-circle mr-2"></i> ${m}`:`<i class="fas fa-exclamation-circle mr-2"></i> ${m}`;document.getElementById('toastBox').appendChild(d);setTimeout(()=>d.remove(),3000);}
        function setLoading(id,l){const b=document.getElementById(id);if(l){b.disabled=true;b.dataset.txt=b.innerText;b.innerHTML='<div class="spinner border-white"></div>';b.classList.add('opacity-75','cursor-not-allowed');}else{b.disabled=false;b.innerText=b.dataset.txt;b.classList.remove('opacity-75','cursor-not-allowed');}}
        function showSection(id){document.querySelectorAll('section').forEach(s=>s.classList.add('hidden-section'));document.getElementById(`view-${id}`).classList.remove('hidden-section');}
        function showPublicHome() { document.getElementById('app-admin').classList.add('hidden-section'); document.getElementById('app-public').classList.remove('hidden-section'); showSection('home'); }
        function logoutUser(){localStorage.removeItem('mediUser');user=null;updateAuthUI();showPublicHome();}
        function logoutPartner(){partnerId=null;showPublicHome();}
        function closeModal(id){document.getElementById(id).classList.add('hidden');}
    </script>
</body>
</html>